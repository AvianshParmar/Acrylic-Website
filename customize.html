<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Trophy Customizer</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;600&display=swap" rel="stylesheet">
  <script src="https://cdn.tailwindcss.com"></script> <!-- Tailwind CSS CDN -->
  <style>
    /* Base styles - Minimal CSS, letting Tailwind handle most */
    * {
      box-sizing: border-box;
      margin: 0;
      padding: 0;
    }

    body {
      font-family: 'Poppins', sans-serif;
      background: #0a0a0a;
      color: white;
    }

    /* Custom scrollbar for controls */
    .controls::-webkit-scrollbar {
        width: 8px;
    }
    .controls::-webkit-scrollbar-track {
        background: rgba(255, 255, 255, 0.05);
        border-radius: 10px;
    }
    .controls::-webkit-scrollbar-thumb {
        background: #00ff5e;
        border-radius: 10px;
    }
    .controls::-webkit-scrollbar-thumb:hover {
        background: #00cc44;
    }


    /* Canvas Area - Custom styles because Tailwind cannot set background-image directly */
    #custom-area {
      /* Background will be set by JS dynamically */
      background-repeat: no-repeat;
      background-position: center;
      background-size: contain;
      box-shadow: 0 0 30px rgba(0, 255, 94, 0.4), inset 0 0 10px rgba(0, 255, 94, 0.1);
      border-radius: 10px;
    }

    /* Resizable Elements (Text and Images) - Custom styles for active state and delete button */
    .resizable {
      position: absolute;
      user-select: none;
      touch-action: none;
      z-index: 10;
      display: flex;
      align-items: center;
      justify-content: center;
      box-sizing: content-box;
      transform-origin: center center;
    }

    .resizable.active {
      outline: 2px solid #00ff5e;
      outline-offset: 4px;
      box-shadow: 0 0 15px rgba(0, 255, 94, 0.6);
      z-index: 20;
    }

    .resizable .remove {
      position: absolute;
      top: calc(-12px - 4px);
      right: calc(-12px - 4px);
      background: #ff4444;
      color: white;
      border: 2px solid #0a0a0a;
      border-radius: 50%;
      font-size: 14px;
      width: 24px;
      height: 24px;
      line-height: 20px;
      text-align: center;
      cursor: pointer;
      z-index: 30;
      display: none;
      box-shadow: 0 2px 8px rgba(0,0,0,0.6);
      transition: background-color 0.2s, transform 0.2s, border-color 0.2s;
    }

    .resizable.active .remove {
        display: flex;
        justify-content: center;
        align-items: center;
    }

    .resizable .remove:hover {
        background: #cc0000;
        transform: scale(1.1);
        border-color: #cc0000;
    }

    .resizable .remove:active {
        transform: scale(0.95);
    }

    .custom-text {
        font-weight: 600;
        text-align: center;
        padding: 5px 10px;
        min-width: 50px;
        min-height: 20px;
        overflow: hidden; 
        white-space: nowrap; 
        text-overflow: ellipsis; 
    }

    .image-element img {
        display: block;
        width: 100%;
        height: 100%;
        object-fit: contain;
    }

    /* Trophy thumbnails */
    .trophy-thumbnail {
        @apply w-20 h-20 rounded-lg object-contain cursor-pointer border-2 border-transparent transition-all duration-200;
    }
    .trophy-thumbnail.selected-trophy {
        @apply border-green-500 shadow-md shadow-green-500/50;
    }
  </style>
</head>
<body class="flex flex-col md:flex-row h-screen overflow-hidden">

  <div class="controls w-full md:w-1/3 min-w-[280px] p-8 bg-white/5 border-r-2 border-green-500/20 overflow-y-auto flex flex-col gap-4">
    <h2 class="text-green-500 text-3xl font-semibold mb-4 text-center">Customize Trophy</h2>

    <div class="mb-6">
        <label class="block text-gray-300 text-sm font-medium mb-2">Select Trophy:</label>
        <div id="trophy-selection" class="flex flex-wrap gap-4 justify-center">
            <!-- Trophy thumbnails will be dynamically loaded here -->
        </div>
    </div>

    <label for="logoUpload" class="block text-gray-300 text-sm font-medium mb-1">Upload Logo:</label>
    <input type="file" id="logoUpload" accept="image/*" class="w-full p-2 bg-gray-900 text-white border border-green-500/50 rounded-lg appearance-none focus:outline-none focus:ring-2 focus:ring-green-500">
    <label for="imageScaleRange" class="block text-gray-300 text-sm font-medium mb-1">Image Scale: <span id="imageScaleValue">100</span>%</label>
    <input type="range" id="imageScaleRange" min="1" max="300" value="100" class="w-full h-6 bg-green-500/20 rounded-lg appearance-none cursor-ew-resize">

    <label for="textInput" class="block text-gray-300 text-sm font-medium mb-1">Enter Text:</label>
    <input type="text" id="textInput" placeholder="Enter your text" value="Your Text Here" class="w-full p-2 bg-gray-900 text-white border border-green-500/50 rounded-lg appearance-none focus:outline-none focus:ring-2 focus:ring-green-500">

    <label for="colorPicker" class="block text-gray-300 text-sm font-medium mb-1">Text Color:</label>
    <input type="color" id="colorPicker" value="#00ff5e" class="w-full h-12 p-1 bg-gray-900 text-white border border-green-500/50 rounded-lg appearance-none">

    <label for="fontSizeRange" class="block text-gray-300 text-sm font-medium mb-1">Font Size: <span id="fontSizeValue">24</span>px</label>
    <input type="range" id="fontSizeRange" min="12" max="72" value="24" class="w-full h-6 bg-green-500/20 rounded-lg appearance-none cursor-ew-resize">
    <input type="number" id="fontSizeNumber" min="12" max="72" value="24" class="w-full p-2 bg-gray-900 text-white border border-green-500/50 rounded-lg appearance-none focus:outline-none focus:ring-2 focus:ring-green-500">

    <label for="rotationRange" class="block text-gray-300 text-sm font-medium mb-1">Rotation: <span id="rotationValue">0</span>Â°</label>
    <input type="range" id="rotationRange" min="-180" max="180" value="0" class="w-full h-6 bg-green-500/20 rounded-lg appearance-none cursor-ew-resize">

    <button onclick="addText()" class="w-full py-2 px-4 bg-green-600 hover:bg-green-700 text-white font-bold rounded-lg shadow-lg transition-all duration-300">Add Text</button>
    <button id="resetBtn" class="w-full py-2 px-4 bg-red-600 hover:bg-red-700 text-white font-bold rounded-lg shadow-lg transition-all duration-300">Reset All</button>
    <button id="downloadBtn" class="w-full py-2 px-4 bg-gradient-to-br from-green-500 to-green-700 text-gray-900 font-bold rounded-lg shadow-lg transition-all duration-300">Download Trophy</button>

    <div class="keyboard-hint text-xs text-gray-500 text-center mt-4 pt-4 border-t border-dashed border-gray-700">
        Hint: Select an object and use your <br>keyboard arrow keys to move it!
        <br>Press the 'Delete' key to remove a selected object.
    </div>
  </div>

  <div class="canvas-wrapper flex-1 relative flex justify-center items-center bg-gradient-to-br from-gray-900 to-gray-700 overflow-hidden">
    <div id="custom-area" class="w-[400px] h-[500px] relative overflow-hidden"></div>
  </div>

  <script src="https://cdn.jsdelivr.net/npm/interactjs/dist/interact.min.js"></script>
  <script src="https://html2canvas.hertzen.com/dist/html2canvas.min.js"></script>
  <script>
    const customArea = document.getElementById('custom-area');
    const logoUpload = document.getElementById('logoUpload');
    const textInput = document.getElementById('textInput');
    const colorPicker = document.getElementById('colorPicker');
    const fontSizeRange = document.getElementById('fontSizeRange');
    const fontSizeNumber = document.getElementById('fontSizeNumber');
    const fontSizeValueSpan = document.getElementById('fontSizeValue');
    const resetBtn = document.getElementById('resetBtn');
    const imageScaleRange = document.getElementById('imageScaleRange');
    const imageScaleValueSpan = document.getElementById('imageScaleValue');
    const rotationRange = document.getElementById('rotationRange');
    const rotationValueSpan = document.getElementById('rotationValue');
    const trophySelectionDiv = document.getElementById('trophy-selection');

    let currentTarget = null;

    // --- Trophy Definitions ---
    // IMPORTANT: Ensure these URLs match the image paths in your products.html
    const trophies = [
      { name: 'Classic Gold', url: 'images/trophy1.png' }, // Matches product card 1
      { name: 'Silver Cup', url: 'images/trophy3.jpg' },  // Matches product card 2 (memento)
      { name: 'Abstract Blue', url: 'https://placehold.co/400x500/4682B4/FFFFFF?text=Trophy+C' },
      { name: 'Wooden Base', url: 'https://placehold.co/400x500/A0522D/FFFFFF?text=Trophy+D' }
    ];

    // --- Utility Functions ---

    function setActive(el) {
        document.querySelectorAll('.resizable').forEach(e => {
            e.classList.remove("active");
            const removeBtn = e.querySelector('.remove');
            if (removeBtn) removeBtn.style.display = 'none';
        });

        el.classList.add("active");
        currentTarget = el;

        const removeBtn = el.querySelector('.remove');
        if (removeBtn) removeBtn.style.display = 'flex';

        if (el.classList.contains("custom-text")) {
            colorPicker.value = rgbToHex(el.style.color);
            fontSizeRange.value = parseInt(el.style.fontSize);
            fontSizeNumber.value = parseInt(el.style.fontSize);
            fontSizeValueSpan.textContent = fontSizeNumber.value;
            textInput.value = el.textContent.trim();
            
            rotationRange.value = parseFloat(el.dataset.rotation) || 0;
            rotationValueSpan.textContent = Math.round(rotationRange.value);

            // Hide image-specific controls
            imageScaleRange.classList.add('hidden');
            document.querySelector('label[for="imageScaleRange"]').classList.add('hidden');
        } else if (el.classList.contains("image-element")) {
            const currentScale = parseFloat(el.getAttribute('data-current-scale')) || 100;
            imageScaleRange.value = currentScale;
            imageScaleValueSpan.textContent = currentScale;
            
            rotationRange.value = parseFloat(el.dataset.rotation) || 0;
            rotationValueSpan.textContent = Math.round(rotationRange.value);

            // Show image-specific controls
            imageScaleRange.classList.remove('hidden');
            document.querySelector('label[for="imageScaleRange"]').classList.remove('hidden');

            textInput.value = "";
            colorPicker.value = "#00ff5e";
            fontSizeRange.value = "24";
            fontSizeNumber.value = "24";
            fontSizeValueSpan.textContent = "24";
        }
    }

    function deactivateAll() {
        document.querySelectorAll('.resizable').forEach(e => {
            e.classList.remove("active");
            const removeBtn = e.querySelector('.remove');
            if (removeBtn) removeBtn.style.display = 'none';
        });
        currentTarget = null;
        imageScaleRange.classList.add('hidden');
        document.querySelector('label[for="imageScaleRange"]').classList.add('hidden');
    }

    function rgbToHex(rgb) {
        if (!rgb || rgb.startsWith('#')) return rgb;
        const result = rgb.match(/\d+/g);
        if (!result || result.length < 3) return "#000000";
        return "#" + result.map(x => {
            const hex = (+x).toString(16);
            return hex.length === 1 ? "0" + hex : hex;
        }).join('');
    }

    // --- Trophy Selection ---
    function loadTrophies() {
        trophySelectionDiv.innerHTML = '';
        trophies.forEach((trophy) => { // Removed index here as we'll handle initial selection in initializeTrophyBackground
            const img = document.createElement('img');
            img.src = trophy.url;
            img.alt = trophy.name;
            img.title = trophy.name;
            img.classList.add('trophy-thumbnail');
            img.addEventListener('click', () => {
                selectTrophy(trophy.url, img);
            });
            trophySelectionDiv.appendChild(img);
        });
    }

    function selectTrophy(imageUrl, clickedThumbnail) {
        customArea.style.backgroundImage = `url('${imageUrl}')`;
        document.querySelectorAll('.trophy-thumbnail').forEach(thumb => {
            thumb.classList.remove('selected-trophy');
        });
        if (clickedThumbnail) { // Check if a thumbnail element was provided
            clickedThumbnail.classList.add('selected-trophy');
        }
    }

    // --- New: Function to initialize trophy background from URL parameter ---
    function initializeTrophyBackgroundFromURL() {
        const urlParams = new URLSearchParams(window.location.search);
        const imageUrlParam = urlParams.get('image'); // Get the image URL from the query parameter

        if (imageUrlParam) {
            // Set the background image of the custom-area using the URL parameter
            customArea.style.backgroundImage = `url('${imageUrlParam}')`;

            // Try to find and select the corresponding thumbnail
            const matchingThumbnail = Array.from(trophySelectionDiv.children).find(thumb => 
                thumb.src.includes(imageUrlParam) // Use includes for partial matching
            );
            if (matchingThumbnail) {
                selectTrophy(imageUrlParam, matchingThumbnail); // Use selectTrophy to apply highlight
            } else {
                // If the URL image doesn't match a predefined thumbnail, ensure none are highlighted
                document.querySelectorAll('.trophy-thumbnail').forEach(thumb => {
                    thumb.classList.remove('selected-trophy');
                });
            }
        } else {
            // If no image parameter, default to the first trophy in the list
            if (trophies.length > 0) {
                selectTrophy(trophies[0].url, trophySelectionDiv.children[0]);
            }
        }
    }


    // --- Element Creation and Interaction Setup ---

    logoUpload.addEventListener('change', e => {
      const file = e.target.files[0];
      if (!file) return;

      const reader = new FileReader();
      reader.onload = () => {
        const imgContainer = document.createElement('div');
        imgContainer.className = 'resizable image-element';
        
        const img = document.createElement('img');
        img.src = reader.result;
        img.draggable = false;

        img.onload = () => {
            const aspectRatio = img.naturalWidth / img.naturalHeight;
            const initialHeight = 120;
            const initialWidth = initialHeight * aspectRatio;

            imgContainer.style.width = `${initialWidth}px`;
            imgContainer.style.height = `${initialHeight}px`;

            imgContainer.setAttribute('data-original-width', initialWidth);
            imgContainer.setAttribute('data-original-height', initialHeight);
            imgContainer.setAttribute('data-current-scale', 100);
            
            imageScaleRange.value = 100;
            imageScaleValueSpan.textContent = 100;
            rotationRange.value = 0;
            rotationValueSpan.textContent = 0;
        };
        imgContainer.appendChild(img);

        addControls(imgContainer);
        customArea.appendChild(imgContainer);
        makeInteractable(imgContainer);
        setActive(imgContainer);
      };
      reader.readAsDataURL(file);
    });

    function addText() {
      if (!textInput.value.trim()) {
        alert("Please enter some text!");
        return;
      }
      const text = document.createElement('div');
      text.className = 'resizable custom-text';
      text.textContent = textInput.value;
      text.style.color = colorPicker.value;
      text.style.fontSize = fontSizeRange.value + 'px';
      text.style.fontWeight = '600';
      text.style.textAlign = 'center';
      text.style.minWidth = '80px';
      text.style.minHeight = '30px';
      text.style.lineHeight = '1.2';

      addControls(text);
      customArea.appendChild(text);
      makeInteractable(text);
      setActive(text);
    }

    function addControls(el) {
      const areaRect = customArea.getBoundingClientRect();
      const elWidth = el.clientWidth || 100;
      const elHeight = el.clientHeight || 100;
      
      el.style.left = `${(areaRect.width / 2) - (elWidth / 2)}px`;
      el.style.top = `${(areaRect.height / 2) - (elHeight / 2)}px`;

      el.style.position = "absolute";
      el.setAttribute('data-x', 0);
      el.setAttribute('data-y', 0);
      el.setAttribute('data-rotation', 0);

      const removeBtn = document.createElement("button");
      removeBtn.className = "remove";
      removeBtn.innerHTML = "Ã";
      removeBtn.onclick = (e) => {
        e.stopPropagation();
        el.remove();
        deactivateAll();
      };
      el.appendChild(removeBtn);

      el.addEventListener("click", (e) => {
        e.stopPropagation();
        setActive(el);
      });
    }

    // --- Control Panel Event Listeners (for selected object) ---

    colorPicker.addEventListener("input", () => {
      if (currentTarget && currentTarget.classList.contains("custom-text")) {
        currentTarget.style.color = colorPicker.value;
      }
    });

    fontSizeRange.addEventListener("input", () => {
      const value = parseInt(fontSizeRange.value);
      fontSizeValueSpan.textContent = value;
      fontSizeNumber.value = value;

      if (currentTarget && currentTarget.classList.contains("custom-text")) {
        currentTarget.style.fontSize = value + 'px';
      }
    });

    fontSizeNumber.addEventListener("input", () => {
      let value = parseInt(fontSizeNumber.value);
      const min = parseInt(fontSizeNumber.min);
      const max = parseInt(fontSizeNumber.max);

      if (isNaN(value)) {
        value = min;
      } else if (value < min) {
        value = min;
      } else if (value > max) {
        value = max;
      }
      
      fontSizeNumber.value = value;
      fontSizeValueSpan.textContent = value;
      fontSizeRange.value = value;

      if (currentTarget && currentTarget.classList.contains("custom-text")) {
        currentTarget.style.fontSize = value + 'px';
      }
    });

    textInput.addEventListener("input", () => {
        if (currentTarget && currentTarget.classList.contains("custom-text")) {
            currentTarget.textContent = textInput.value;
        }
    });

    imageScaleRange.addEventListener('input', () => {
        imageScaleValueSpan.textContent = imageScaleRange.value;
        if (currentTarget && currentTarget.classList.contains("image-element")) {
            const originalWidth = parseFloat(currentTarget.getAttribute('data-original-width'));
            const originalHeight = parseFloat(currentTarget.getAttribute('data-original-height'));
            const scaleValue = parseFloat(imageScaleRange.value) / 100;

            if (!isNaN(originalWidth) && !isNaN(originalHeight) && !isNaN(scaleValue) && scaleValue > 0) {
                const newWidth = originalWidth * scaleValue;
                const newHeight = originalHeight * scaleValue;

                currentTarget.style.width = `${newWidth}px`;
                currentTarget.style.height = `${newHeight}px`;
                currentTarget.setAttribute('data-current-scale', imageScaleRange.value);
            }
        }
    });

    rotationRange.addEventListener('input', () => {
        const value = parseInt(rotationRange.value);
        rotationValueSpan.textContent = value;
        if (currentTarget) {
            currentTarget.dataset.rotation = value;
            const x = parseFloat(currentTarget.getAttribute('data-x')) || 0;
            const y = parseFloat(currentTarget.getAttribute('data-y')) || 0;
            currentTarget.style.transform = `translate(${x}px, ${y}px) rotate(${value}deg)`;
        }
    });

    // --- Global Click and Keyboard Handlers ---

    document.addEventListener("click", e => {
      if (!e.target.closest(".resizable") && !e.target.closest(".controls")) {
        deactivateAll();
      }
    });

    document.addEventListener('keydown', (e) => {
        if (!currentTarget) return;

        if (e.key === 'Delete' || e.key === 'Backspace') {
            e.preventDefault();
            currentTarget.remove();
            deactivateAll();
            return;
        }

        const step = 5;
        let x = (parseFloat(currentTarget.getAttribute('data-x')) || 0);
        let y = (parseFloat(currentTarget.getAttribute('data-y')) || 0);
        const rotation = (parseFloat(currentTarget.dataset.rotation) || 0);

        let moved = false;

        switch (e.key) {
            case 'ArrowUp':
                y -= step;
                moved = true;
                break;
            case 'ArrowDown':
                y += step;
                moved = true;
                break;
            case 'ArrowLeft':
                x -= step;
                moved = true;
                break;
            case 'ArrowRight':
                x += step;
                moved = true;
                break;
        }

        if (moved) {
            e.preventDefault();
            currentTarget.style.transform = `translate(${x}px, ${y}px) rotate(${rotation}deg)`;
            currentTarget.setAttribute('data-x', x);
            currentTarget.setAttribute('data-y', y);
        }
    });

    // --- Interact.js Setup (Drag and Rotate Only) ---
    function makeInteractable(el) {
      interact(el)
        .draggable({
          listeners: {
            start(event) {
                setActive(event.target);
            },
            move(event) {
              const target = event.target;
              const x = (parseFloat(target.getAttribute('data-x')) || 0) + event.dx;
              const y = (parseFloat(target.getAttribute('data-y')) || 0) + event.dy;

              target.style.transform = `translate(${x}px, ${y}px) rotate(${target.dataset.rotation || 0}deg)`;

              target.setAttribute('data-x', x);
              target.setAttribute('data-y', y);
            }
          },
          modifiers: [
            interact.modifiers.restrictRect({
              restriction: 'parent',
              endOnly: true
            })
          ]
        })
        .gesturable({
          listeners: {
            start(event) {
                setActive(event.target);
            },
            move(event) {
              const target = event.target;
              const currentAngle = parseFloat(target.dataset.rotation) || 0;
              const newAngle = currentAngle + event.da;
              target.dataset.rotation = newAngle;

              const x = parseFloat(target.getAttribute('data-x')) || 0;
              const y = parseFloat(target.getAttribute('data-y')) || 0;

              target.style.transform = `translate(${x}px, ${y}px) rotate(${newAngle}deg)`;
              rotationRange.value = newAngle;
              rotationValueSpan.textContent = Math.round(newAngle);
            }
          }
        });
    }

    // --- Reset Functionality ---
    resetBtn.addEventListener('click', () => {
        while (customArea.firstChild) {
            customArea.removeChild(customArea.firstChild);
        }
        deactivateAll();

        textInput.value = "Your Text Here";
        colorPicker.value = "#00ff5e";
        fontSizeRange.value = "24";
        fontSizeNumber.value = "24";
        fontSizeValueSpan.textContent = "24";
        logoUpload.value = "";
        imageScaleRange.value = "100";
        imageScaleValueSpan.textContent = "100";
        rotationRange.value = "0";
        rotationValueSpan.textContent = "0";
    });

    // --- Download Functionality ---
    document.getElementById("downloadBtn").addEventListener("click", () => {
      const elements = document.querySelectorAll(".resizable");

      elements.forEach(e => {
          e.classList.remove("active");
          const removeBtn = e.querySelector('.remove');
          if (removeBtn) removeBtn.style.display = 'none';
      });

      const clone = customArea.cloneNode(true);
      clone.querySelectorAll('.remove').forEach(btn => btn.remove());
      clone.style.boxShadow = 'none';

      clone.querySelectorAll('.resizable').forEach(clonedEl => {
          const originalEl = Array.from(elements).find(o =>
              o.getAttribute('data-x') === clonedEl.getAttribute('data-x') &&
              o.getAttribute('data-y') === clonedEl.getAttribute('data-y') &&
              o.getAttribute('data-rotation') === clonedEl.getAttribute('data-rotation')
          );

          if (originalEl) {
              clonedEl.style.transform = originalEl.style.transform;
              clonedEl.style.width = originalEl.style.width;
              clonedEl.style.height = originalEl.style.height;

              if (originalEl.classList.contains('custom-text')) {
                  clonedEl.style.color = originalEl.style.color;
                  clonedEl.style.fontSize = originalEl.style.fontSize;
              }
          }
      });

      document.body.appendChild(clone);
      clone.style.position = 'absolute';
      clone.style.left = '-9999px';
      clone.style.top = '-9999px';

      html2canvas(clone, {
          backgroundColor: null,
          useCORS: true,
          scale: 2
      }).then(canvas => {
        const link = document.createElement("a");
        link.download = "trophy-customized.png";
        link.href = canvas.toDataURL("image/png");
        link.click();

        if (currentTarget) {
            setActive(currentTarget);
        } else {
            deactivateAll();
        }
        clone.remove();
      }).catch(error => {
          console.error("Error generating image:", error);
          alert("Error generating image. Please try again. Ensure your trophy image is hosted correctly or loaded from the same origin.");
          if (currentTarget) {
              setActive(currentTarget);
          } else {
              deactivateAll();
          }
          clone.remove();
      });
    });

    // --- Initialization on Load ---
    loadTrophies(); // Load trophy thumbnails
    initializeTrophyBackgroundFromURL(); // Initialize background based on URL parameter or default
    
    // Initial display values
    fontSizeValueSpan.textContent = fontSizeRange.value;
    fontSizeNumber.value = fontSizeRange.value;
    imageScaleValueSpan.textContent = imageScaleRange.value;
    rotationValueSpan.textContent = rotationRange.value;
    deactivateAll(); // Ensure a clean initial state
  </script>
</body>
</html>
